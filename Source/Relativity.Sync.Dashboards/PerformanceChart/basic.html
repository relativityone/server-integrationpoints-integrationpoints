<!doctype html>
<html>
<script src=".\azurestoragejs-3.0.100\bundle\azure-storage.table.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"
    integrity="sha512-d9xgZrVZpmmQlfonhQUvTR7lMPtO7NkZMkA0ABN3PHCbKA5nqylQ/yWlFAyY6hYgdF1Qh6nYiuADWwKB4C2WSw=="
    crossorigin="anonymous"></script>
<canvas id="myChart"></canvas>
<script>
    var tableUri = 'https://' + 'relativitysyncstorage' + '.table.core.windows.net';
    var SAS_TOKEN = '?sv=2020-08-04&ss=t&srt=o&sp=r&se=2023-01-01T16:39:45Z&st=2022-01-05T08:39:45Z&spr=https&sig=dgOXOS7IUc9%2BxrBgaICiBg370E%2FysDaQYSSerN1CHJI%3D';
    var tableService = AzureStorage.Table.createTableServiceWithSas(tableUri, SAS_TOKEN);
    const days_range = 30;

    Date.prototype.addDays = function (days) {
        var date = new Date(this.valueOf());
        date.setDate(date.getDate() + days);
        return date;
    }
    var todayMinusDaysRange = new Date().addDays(-days_range);
    var dateFilter = AzureStorage.Table.TableQuery.dateFilter('Timestamp', 'gt', todayMinusDaysRange);
    var query = new AzureStorage.Table.TableQuery().where(dateFilter);

    tableService.queryEntities('SyncReferenceJobsPerformanceTestsResults', query, null, function (error, result) {
        result.entries.sort(
            function (a, b) {
                return a.RowKey._ - b.RowKey._
            }
        );

        // extract needed fields
        var azureData = result.entries.map(x => {
            return {
                label: x.Timestamp._.toDateString(),
                y: x.Duration._,
                x: x.RowKey._
            };
        });

        var chartData = {
            labels: azureData.map(x => x.label),
            datasets: [
                {
                    label: 'Test Duration [s]',
                    data: azureData
                },
                {
                    label: 'Moving avg 7 days',
                    data: nDayAverageData(7, azureData),
                    borderColor: 'BLACK',
                    fill: false
                }
            ]
        }        

        var ctx = document.getElementById('myChart').getContext('2d');
        var chart = new Chart(ctx,
            {
                type: 'line',
                data: chartData,
                options:
                {
                    title: {
                        display: true,
                        text: 'Last ' + days_range + ' Days Results'
                    },
                    scales:
                    {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]

                    }
                }
            }
        );
    });

    function nDayAverageData(n, data) {
        var array = [];
        var dataNDays = data.slice(n);
        var averages = nDayAverage(n, data.map(x => x.y));

        var result = zip(dataNDays, averages, (d, a) => {
            return {
                x: d.x,
                y: a,
                label: d.label
            }
        });

        var emptyFront = data.slice(0, n).map(x => { return { x: x.label, y: undefined } });

        return emptyFront.concat(result);
    }

    function nDayAverage(n, results) {
        var movingAverage = [];
        for (let i = n; i < results.length; i++) {
            var currentArray = results.slice(i - n, i);
            var average = sumOfNumbers(currentArray) / n;
            movingAverage.push(average);
        }
        return movingAverage;
    }

    function sumOfNumbers(numbers) {
        var sum = 0;
        numbers.forEach(element => {
            sum += element;
        });
        return sum;
    }

    function zip(a1, a2, mergeFun) {
        return a1.map((x, i) => mergeFun(x, a2[i]));
    }
</script>

</html>