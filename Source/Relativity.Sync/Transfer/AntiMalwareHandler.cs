using System;
using System.Threading.Tasks;
using Relativity.Sync.AntiMalware.SDK;
using Relativity.API;
using Relativity.Sync.Configuration;
using Relativity.Sync.Toggles;
using Relativity.Sync.Toggles.Service;
using Relativity.Sync.Transfer.StreamWrappers;

namespace Relativity.Sync.Transfer
{
    internal class AntiMalwareHandler : IAntiMalwareHandler
    {
        private readonly SyncJobParameters _parameters;
        private readonly IAntiMalwareEventHelper _antiMalwareEventHelper;
        private readonly IAntiMalwareConfiguration _configuration;
        private readonly ISyncToggles _toggles;
        private readonly IFileStreamBuilder _fileStreamBuilder;
        private readonly IAPILog _log;

        public AntiMalwareHandler(
            SyncJobParameters parameters,
            IAntiMalwareEventHelper antiMalwareEventHelper,
            IAntiMalwareConfiguration configuration,
            ISyncToggles toggles,
            IFileStreamBuilder fileStreamBuilder,
            IAPILog log)
        {
            _parameters = parameters;
            _antiMalwareEventHelper = antiMalwareEventHelper;
            _configuration = configuration;
            _toggles = toggles;
            _fileStreamBuilder = fileStreamBuilder;
            _log = log;
        }

        public async Task<bool> ContainsMalwareAsync(IFile file)
        {
            // TODO this must be removed once TAPI implements the fix on their end
            if (_toggles.IsEnabled<EnableMalwareDetectionToggle>() && _configuration.IsPhysicalFileCopyMode)
            {
                try
                {
                    _fileStreamBuilder.Create(file);
                }
                catch (Exception e)
                {
                    _log.LogError(e, "Error occurred in AntiMalware validation.");
                }
            }

            return false;
        }

        private async Task HandleEventAsync(Exception ex, IFile file)
        {
            try
            {
                _log.LogWarning(ex, "Malware detected for document {documentId} in file {filePath}", file.DocumentArtifactId, file.Location);

                AntiMalwareEvent antiMalwareEvent = new AntiMalwareEvent
                {
                };

                await _antiMalwareEventHelper.ReportAntiMalwareEventAsync(antiMalwareEvent).ConfigureAwait(false);
            }
            catch (Exception e)
            {
                _log.LogError(e, "Error occurred in AntiMalware Event Report.");
            }
        }
    }
}
