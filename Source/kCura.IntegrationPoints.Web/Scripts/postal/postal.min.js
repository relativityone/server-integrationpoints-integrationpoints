(function(n,t){typeof module=="object"&&module.exports?module.exports=t(require("lodash"),require("conduitjs"),this):typeof define=="function"&&define.amd?define(["lodash","conduitjs"],function(i,r){return t(i,r,n)}):n.postal=t(n._,n.Conduit,n)})(this,function(n,t,i){function p(){while(s.length)r.unsubscribe(s.shift())}function h(n,t){return{channel:r.configuration.SYSTEM_CHANNEL,topic:"subscription."+n,data:{event:"subscription."+n,channel:t.channel,topic:t.topic}}}function w(t){return typeof t=="function"?t:t?function(i){var u=0,f=0;return n.each(t,function(n,e){u+=1;(e==="topic"&&r.configuration.resolver.compare(i.topic,t.topic)||e==="context"&&t.context===(i.callback.context&&i.callback.context()||i.context)||i[e]===t[e])&&(f+=1)}),u===f}:function(){return!0}}function b(n){var t=new o(n.channel||this.configuration.DEFAULT_CHANNEL,n.topic,n.callback),r=this.subscriptions[t.channel],i;return r||(r=this.subscriptions[t.channel]={}),i=this.subscriptions[t.channel][t.topic],i||(i=this.subscriptions[t.channel][t.topic]=[]),i.push(t),t}function k(t){++e;t.channel=t.channel||this.configuration.DEFAULT_CHANNEL;t.timeStamp=new Date;n.each(this.wireTaps,function(n){n(t.data,t,e)});this.subscriptions[t.channel]&&n.each(this.subscriptions[t.channel],function(n){for(var i=0,u=n.length,r;i<u;)(r=n[i++])&&y(r,t)});--e==0&&p()}function d(){for(var u=0,c=Array.prototype.slice.call(arguments,0),t,f,i,o;t=c.shift();){if(e){s.push(t);return}if(f=this.subscriptions[t.channel],i=f&&f[t.topic],i){for(o=i.length,u=0;u<o;){if(i[u]===t){i.splice(u,1);break}u+=1}i.length===0&&(delete f[t.topic],n.isEmpty(f)&&delete this.subscriptions[t.channel])}r.publish(h("removed",t))}}var r,c=i.postal,f=function(n){this.channel=n||r.configuration.DEFAULT_CHANNEL;this.initialize()};f.prototype.initialize=function(){var n=this.publish;this.publish=new t.Async({target:n,context:this})};f.prototype.subscribe=function(){return r.subscribe({channel:this.channel,topic:arguments.length===1?arguments[0].topic:arguments[0],callback:arguments.length===1?arguments[0].callback:arguments[1]})};f.prototype.publish=function(){var n=arguments.length===1?Object.prototype.toString.call(arguments[0])==="[object String]"?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};n.channel=this.channel;r.publish(n)};var o=function(n,t,i){if(arguments.length!==3)throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(t.length===0)throw new Error("Topics cannot be empty");this.channel=n;this.topic=t;this.subscribe(i)},l=function(){var t;return function(i){var r=!1;return n.isString(i)?(r=i===t,t=i):(r=n.isEqual(i,t),t=n.clone(i)),!r}},a=function(){var t=[];return function(i){var r=!n.any(t,function(t){return n.isObject(i)||n.isArray(i)?n.isEqual(i,t):i===t});return r&&t.push(i),r}},u={withDelay:function(t){if(n.isNaN(t))throw"Milliseconds must be a number";return{name:"withDelay",fn:function(n,i,r){setTimeout(function(){n(i,r)},t)}}},defer:function(){return this.withDelay(0)},stopAfter:function(t,i){if(n.isNaN(t)||t<=0)throw"The value provided to disposeAfter (maxCalls) must be a number greater than zero.";var r=n.after(t,i);return{name:"stopAfter",fn:function(n,t,i){r();n(t,i)}}},withThrottle:function(t){if(n.isNaN(t))throw"Milliseconds must be a number";return{name:"withThrottle",fn:n.throttle(function(n,t,i){n(t,i)},t)}},withDebounce:function(t,i){if(n.isNaN(t))throw"Milliseconds must be a number";return{name:"debounce",fn:n.debounce(function(n,t,i){n(t,i)},t,!!i)}},withConstraint:function(t){if(!n.isFunction(t))throw"Predicate constraint must be a function";return{name:"withConstraint",fn:function(n,i,r){t.call(this,i,r)&&n.call(this,i,r)}}},distinct:function(n){n=n||{};var t=function(n){return n[0]},i=n.all?new a(t):new l(t);return{name:"distinct",fn:function(n,t,r){i(t)&&n(t,r)}}}};o.prototype={after:function(){return this.callback.after.apply(this,arguments),this},before:function(){return this.callback.before.apply(this,arguments),this},"catch":function(n){var t=this.callback.target(),i=function(){try{t.apply(this,arguments)}catch(i){n(i,arguments[0])}};return this.callback.target(i),this},defer:function(){return this.callback.before(u.defer()),this},disposeAfter:function(n){var t=this;return t.callback.before(u.stopAfter(n,function(){t.unsubscribe.call(t)})),t},distinctUntilChanged:function(){return this.callback.before(u.distinct()),this},distinct:function(){return this.callback.before(u.distinct({all:!0})),this},logError:function(){if(console){var n;n=console.warn?console.warn:console.log;this["catch"](n)}return this},once:function(){return this.disposeAfter(1),this},subscribe:function(n){return this.callback=new t.Async({target:n,context:this}),this},unsubscribe:function(){this.inactive||(this.inactive=!0,r.unsubscribe(this))},withConstraint:function(n){return this.callback.before(u.withConstraint(n)),this},withConstraints:function(n){while(n.length)this.callback.before(u.withConstraint(n.shift()));return this},withDebounce:function(n,t){return this.callback.before(u.withDebounce(n,t)),this},withDelay:function(n){return this.callback.before(u.withDelay(n)),this},withThrottle:function(n){return this.callback.before(u.withThrottle(n)),this},withContext:function(n){return this.callback.context(n),this}};var v={cache:{},regex:{},compare:function(t,i){var e,u,f,r=this.cache[i]&&this.cache[i][t];return typeof r!="undefined"?r:((u=this.regex[t])||(e="^"+n.map(t.split("."),function(n){var t="";return!f||(t=f!=="#"?"\\.\\b":"\\b"),t+=n==="#"?"[\\s\\S]*":n==="*"?"[^.]+":n,f=n,t}).join("")+"$",u=this.regex[t]=new RegExp(e)),this.cache[i]=this.cache[i]||{},this.cache[i][t]=r=u.test(i),r)},reset:function(){this.cache={};this.regex={}}},y=function(n,t){!n.inactive&&r.configuration.resolver.compare(n.topic,t.topic)&&n.callback(t.data,t)},e=0,s=[];if(r={configuration:{resolver:v,DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal"},subscriptions:{},wireTaps:[],ChannelDefinition:f,SubscriptionDefinition:o,channel:function(n){return new f(n)},addWireTap:function(n){var t=this;return t.wireTaps.push(n),function(){var i=t.wireTaps.indexOf(n);i!==-1&&t.wireTaps.splice(i,1)}},noConflict:function(){if(typeof window=="undefined"||typeof window!="undefined"&&typeof define=="function"&&define.amd)throw new Error("noConflict can only be used in browser clients which aren't using AMD modules");return i.postal=c,this},getSubscribersFor:function(t){var i=[];return n.each(this.subscriptions,function(r){n.each(r,function(r){i=i.concat(n.filter(r,w(t)))})}),i},reset:function(){this.unsubscribeFor();this.configuration.resolver.reset();this.subscriptions={}},unsubscribeFor:function(n){var t=[];this.subscriptions&&(t=this.getSubscribersFor(n),this.unsubscribe.apply(this,t))}},r.subscribe=new t.Sync({target:b,context:r}),r.publish=t.Async({target:k,context:r}),r.unsubscribe=new t.Sync({target:d,context:r}),r.subscribe.after(function(n){r.publish(h("created",n))}),r.subscriptions[r.configuration.SYSTEM_CHANNEL]={},r.linkChannels=function(t,i){var u=[],r=this;return t=n.isArray(t)?t:[t],i=n.isArray(i)?i:[i],n.each(t,function(t){var f=t.topic||"#";n.each(i,function(i){var e=i.channel||r.configuration.DEFAULT_CHANNEL;u.push(r.subscribe({channel:t.channel||r.configuration.DEFAULT_CHANNEL,topic:f,callback:function(t,u){var f=n.clone(u);f.topic=n.isFunction(i.topic)?i.topic(u.topic):i.topic||u.topic;f.channel=e;f.data=t;r.publish(f)}}))})}),u},i&&Object.prototype.hasOwnProperty.call(i,"__postalReady__")&&n.isArray(i.__postalReady__))while(i.__postalReady__.length)i.__postalReady__.shift().onReady(r);return r});
/*
//# sourceMappingURL=postal.min.js.map
*/