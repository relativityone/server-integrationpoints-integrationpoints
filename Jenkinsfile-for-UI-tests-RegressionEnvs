#!groovy

def jenkinsHelpers = load "DevelopmentScripts/JenkinsHelpers.groovy"
jenkinsHelpers.initializeRIPPipeline(this, env, params, relativityBranchFallback)

interface UiPipelinesNames
{
	final String REG_UI_IMPORT_EXPORT_JOB_NAME = "IntegrationPointsUIReg-ImportExport"
	final String REG_UI_SYNC_TOGGLE_ON_JOB_NAME = "IntegrationPointsUIReg-SyncToggleOn"
	final String REG_UI_SYNC_TOGGLE_OFF_JOB_NAME = "IntegrationPointsUIReg-SyncToggleOff"
}

def isUIRegImportExport()
{
	return env.JOB_NAME.contains(UiPipelinesNames.REG_UI_IMPORT_EXPORT_JOB_NAME)
}

def isUIRegSyncToggleOn()
{
	return env.JOB_NAME.contains(UiPipelinesNames.REG_UI_SYNC_TOGGLE_ON_JOB_NAME)
}

def isUIRegSyncToggleOff()
{
	return env.JOB_NAME.contains(UiPipelinesNames.REG_UI_SYNC_TOGGLE_OFF_JOB_NAME)
}

def getPipelineName()
{
	if(isUIRegImportExport())
	{
		return Constants.UI_IMPORT_EXPORT_JOB_NAME
	}
	if(isUIRegSyncToggleOn())
	{
		return Constants.UI_SYNC_TOGGLE_ON_JOB_NAME
	}
	if(isUIRegSyncToggleOff())
	{
		return Constants.UI_SYNC_TOGGLE_OFF_JOB_NAME
	}
	error "Unknown UI test type!"
}

def pipelineName = getPipelineName()
def jenkinsPipelineLocation = "DataTransfer/$pipelineName"
def jobFullPath = "${jenkinsPipelineLocation}/${env.BRANCH_NAME}"

timestamps{
	stage ('Trigger UI Test'){
		def r1EnvironmentConfigName = selectEnvironmentConfigNameBasedOnBranch(env.BRANCH_NAME)
		echo "Current branch: ${env.BRANCH_NAME} Regression config: ${r1EnvironmentConfigName}"
		try {
			withCredentials([usernamePassword(credentialsId: 'RipUiUserRegressionEnvs', passwordVariable: 'RipUiUserPassword', usernameVariable: 'RipUiUserUsername')]){
				build job: jobFullPath, parameters: [
				string(name: 'ripUiTestsConfig', value: r1EnvironmentConfigName),
				string(name: 'ripTestsAdminUsername', value: 'RipUiUserUsername'),
				string(name: 'ripTestsAdminPassword', value: 'RipUiUserPassword'),
				string(name: 'testsFilter', value: 'cat != NotWorkingOnRegressionEnvironment')
				], wait: false
			}
		}
		catch (Exception ex) {
			echo "Job ${jobFullPath} not triggered: ${ex}"
			currentBuild.result = "FAILED"
		}
	}
}

def selectEnvironmentConfigNameBasedOnBranch(branchName){
	switch(branchName) {
		case 'release-10.2-foxglove':
			return 'Reg-A.config'
		break
		case 'release-10.1-blazingstar2':
			return 'Reg-Prod-Update.config'
		break
		default:
			//Develop or newest version
			return 'Reg-Zero.config'
		break
	}
}